---

- name: add default section tag
  lineinfile:
    dest: /etc/mongodb.conf
    line: '[DEFAULT]'
    insertbefore: BOF
  become: yes
  become_method: sudo
  tags: ini
- name: configure mongodb
  ini_file: >
    dest=/etc/mongodb.conf
    section=DEFAULT
    option="{{ item.option }}"
    value="{{ item.value }}"
    backup=yes
  with_items:
    - option: bind_ip
      value: "{{ manage_ip }}"
    - option: smallfiles
      value: true
  register: ret
  become: yes
  become_method: sudo
  tags: ini
- debug: var=ret
  tags: ini
- name: remove default section tag
  lineinfile:
    dest: /etc/mongodb.conf
    line: '[DEFAULT]'
    state: absent
  become: yes
  become_method: sudo
  tags: ini
- name: stop mongodb
  service:
    name: mongodb
    enabled: yes
    state: stopped
  become: yes
  become_method: sudo

- name: remove prealloc.*
  file:
    path: /var/lib/mongodb/journal/prealloc.*
    state: absent
  become: yes
  become_method: sudo

- name: start mongodb
  service:
    name: mongodb
    enabled: yes
    state: started
  become: yes
  become_method: sudo

...

